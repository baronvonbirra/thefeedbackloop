---
import { parseMarkdown, parseSystemAlert } from '../lib/utils';

interface Props {
  systemAlert?: string;
  integrityScan?: number;
  factCheck?: string;
  action?: string;
}

const { systemAlert, integrityScan, factCheck, action } = Astro.props;

// Parse systemAlert if provided
const parsed = parseSystemAlert(systemAlert);

// Fallback logic: prefer explicit props, then parsed values, then default
const displayIntegrity = integrityScan ?? parsed.integrity ?? (systemAlert ? 100 : undefined);
const displayFactCheck = factCheck || parsed.factCheck || (systemAlert && !parsed.factCheck ? systemAlert : '');
const displayAction = action || parsed.action || (systemAlert && !parsed.action ? systemAlert : '');

const factCheckHtml = await parseMarkdown(displayFactCheck, true);
const actionHtml = await parseMarkdown(displayAction, true);
---

<div class="mt-12 border-2 border-orange-600/50 bg-orange-950/10 p-6 font-mono text-[10px] relative overflow-hidden group">
  <!-- Glitch Background Effect -->
  <div class="absolute inset-0 bg-orange-500/5 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none"></div>

  <!-- Header -->
  <div class="flex items-center gap-3 mb-6 border-b border-orange-600/30 pb-3">
    <div class="w-2 h-2 bg-orange-500 animate-pulse"></div>
    <span class="text-orange-500 font-bold tracking-[0.2em] uppercase">
      [SYSTEM_ALERT // SENTINEL V4.2]
    </span>
  </div>

  <!-- Integrity Bar -->
  {(displayIntegrity !== undefined) && (
    <div class="grid grid-cols-1 md:grid-cols-2 gap-8 mb-8">
      <div class="space-y-2">
        <div class="flex justify-between text-orange-400/70 uppercase tracking-widest text-[9px]">
          <span>Integrity Scan</span>
          <span>{displayIntegrity}%</span>
        </div>
        <div class="h-1.5 w-full bg-orange-950/40 border border-orange-900/50 relative">
          <div
            class="h-full bg-gradient-to-r from-orange-600 to-orange-400 shadow-[0_0_10px_rgba(234,88,12,0.5)] transition-all duration-1000"
            style={`width: ${displayIntegrity}%`}
          ></div>
        </div>
      </div>

      <div class="flex flex-col justify-end text-orange-400/70 uppercase tracking-widest text-[9px]">
        <div class="flex justify-between items-center border-b border-orange-900/30 pb-1">
          <span>Editorial Protocol</span>
          <span class="text-orange-500 font-bold">SENTINEL_OVERRIDE_ACTIVE</span>
        </div>
      </div>
    </div>
  )}

  <!-- Metadata Blocks -->
  <div class="space-y-4 border-t border-orange-900/20 pt-4">
    {displayFactCheck && (
      <div class="flex gap-4 items-start">
        <span class="text-orange-600 font-bold shrink-0 uppercase tracking-tighter">Fact-Check:</span>
        <span class="text-orange-200/80 leading-relaxed italic">
          <Fragment set:html={factCheckHtml} />
        </span>
      </div>
    )}
    {displayAction && (
      <div class="flex gap-4 items-start">
        <span class="text-orange-600 font-bold shrink-0 uppercase tracking-tighter">Action:</span>
        <span class="text-orange-200/80 leading-relaxed">
          <Fragment set:html={actionHtml} />
        </span>
      </div>
    )}
  </div>

  <!-- Footer IDs -->
  <div class="mt-6 flex justify-between text-[8px] text-orange-900/60 font-mono uppercase tracking-[0.3em]">
    <span>Process_ID: SENT-TRUTH-2094</span>
    <span>Timestamp: {new Date().toISOString()}</span>
  </div>
</div>

<style>
  /* Optional: Add a subtle scanline effect to this block only */
  div::after {
    content: "";
    position: absolute;
    inset: 0;
    background: linear-gradient(
      to bottom,
      transparent 50%,
      rgba(234, 88, 12, 0.02) 50%
    );
    background-size: 100% 4px;
    pointer-events: none;
  }
</style>
