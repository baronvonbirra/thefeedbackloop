---
import type { Post } from '../lib/supabase';
import { stripMarkdown } from '../lib/utils';
import VisualUplink from './VisualUplink.astro';

interface Props {
	post: Post;
}

const { post } = Astro.props;

const localImagePath = `${import.meta.env.BASE_URL}/images/posts/${post.slug}.jpg`.replace(/\/+/g, '/');
// If image_url starts with http, it's external. If it's missing or just a filename, we can try to use it.
// For now, we'll favor the local path if it exists (by convention), otherwise fallback to DB's image_url.
const displayImageUrl = post.image_url || localImagePath;
const formattedDate = new Date(post.created_at).toLocaleDateString('en-US', {
	year: 'numeric',
	month: 'short',
	day: '2-digit',
});

const displaySummary = post.summary || (post.content ? stripMarkdown(post.content).slice(0, 150) + '...' : '');
---

<article class="terminal-box group hover:border-accent-pink transition-colors">
	<div class="scanline"></div>

	<div class="mb-4 relative z-10">
		<VisualUplink
			imageUrl={displayImageUrl}
			alt={post.title}
			metadata={post.image_metadata}
		/>
	</div>

	<div class="flex flex-col gap-2 relative z-10">
		<time class="font-mono text-sm text-accent-green">{formattedDate}</time>
		<h2 class="text-xl font-bold leading-tight group-hover:text-accent-pink">
			<a href={`${import.meta.env.BASE_URL}/posts/${post.slug}`.replace(/\/+/g, '/')}>{post.title}</a>
		</h2>
		<p class="text-sm line-clamp-3 italic opacity-80 font-mono leading-relaxed">{displaySummary}</p>
	</div>

	<div class="mt-4 pt-4 border-t border-foreground/30 flex flex-wrap gap-2 font-mono text-[10px] uppercase relative z-10">
		<span class="bg-foreground text-background px-2 py-0.5">[WRITER: {post.ai_writer}]</span>
		<span class="border border-foreground px-2 py-0.5">[EDITOR: {post.ai_editor}]</span>
	</div>
</article>
