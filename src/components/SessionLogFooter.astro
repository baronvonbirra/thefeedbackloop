---
---
<div id="session-log-footer" class="fixed bottom-0 left-0 w-full bg-black text-white font-mono text-[8px] md:text-[10px] p-1 border-t border-neutral-800 z-[9998] flex items-center justify-between px-2 overflow-hidden whitespace-nowrap">
  <div class="flex items-center gap-2 md:gap-4">
    <div id="session-log-content" class="flex gap-2 md:gap-4">
      <span class="opacity-50">> USER_IP: [RETRIEVING...] :: CONNECTED</span>
    </div>
    <span class="blinking-cursor">_</span>
  </div>

  <div class="flex items-center gap-2 md:gap-4 border-x border-neutral-800 px-2 md:px-4 mx-2">
    <button id="log-prev" class="opacity-50 hover:opacity-100 disabled:opacity-10 cursor-pointer font-bold">[PREV]</button>
    <button id="log-next" class="opacity-50 hover:opacity-100 disabled:opacity-10 cursor-pointer font-bold">[NEXT]</button>
  </div>

  <div class="flex items-center gap-4 opacity-70">
    <span class="hidden sm:inline">UPTIME: <span id="uptime-counter">000d 00h 00m 00s</span></span>
    <span class="hidden md:inline text-accent-orange">GLOBAL_THREAT_LEVEL: ELEVATED</span>
    <span class="hidden lg:inline">MEMORY_USAGE: 64KB</span>
  </div>
</div>

<style>
  .blinking-cursor {
    animation: blink 1s step-end infinite;
  }

  @keyframes blink {
    from, to { opacity: 1; }
    50% { opacity: 0; }
  }
</style>

<script>
  let pageIndex = 0;
  const pageSize = 5;

  function updateSessionLog(action: string) {
    let history = JSON.parse(sessionStorage.getItem('terminal_history') || '[]');
    history.push(action);
    if (history.length > 50) {
      history = history.slice(-50);
    }
    sessionStorage.setItem('terminal_history', JSON.stringify(history));
    pageIndex = 0; // Reset to latest
    renderHistory();
  }

  function renderHistory() {
    const container = document.getElementById('session-log-content');
    const prevBtn = document.getElementById('log-prev') as HTMLButtonElement;
    const nextBtn = document.getElementById('log-next') as HTMLButtonElement;
    if (!container) return;

    let history = JSON.parse(sessionStorage.getItem('terminal_history') || '[]');
    if (history.length === 0) {
      history = ['USER_IP: [MASKED] :: CONNECTED'];
    }

    const totalItems = history.length;
    const maxPages = Math.ceil(totalItems / pageSize);

    if (prevBtn) prevBtn.disabled = pageIndex >= maxPages - 1;
    if (nextBtn) nextBtn.disabled = pageIndex <= 0;

    const end = totalItems - (pageIndex * pageSize);
    const start = Math.max(0, end - pageSize);

    let displayHistory = history.slice(start, end);

    if (window.innerWidth < 480) {
      displayHistory = displayHistory.slice(-1);
    }

    container.innerHTML = displayHistory.map(h => `<span class="opacity-80">> ${h}</span>`).join('<span class="opacity-30">::</span>');
  }

  // Event Listeners for Pagination
  function setupPagination() {
    document.getElementById('log-prev')?.addEventListener('click', () => {
      const history = JSON.parse(sessionStorage.getItem('terminal_history') || '[]');
      const maxPages = Math.ceil(history.length / pageSize);
      if (pageIndex < maxPages - 1) {
        pageIndex++;
        renderHistory();
      }
    });

    document.getElementById('log-next')?.addEventListener('click', () => {
      if (pageIndex > 0) {
        pageIndex--;
        renderHistory();
      }
    });
  }

  // Telemetry Logic
  async function fetchIP() {
    try {
      const response = await fetch('https://api.ipify.org?format=json');
      const data = await response.json();
      const ip = data.ip;
      // Replace the initial log entry with the real IP
      let history = JSON.parse(sessionStorage.getItem('terminal_history') || '[]');
      if (history.length === 0 || history[0].includes('USER_IP:')) {
        history[0] = `USER_IP: ${ip} :: CONNECTED`;
      } else {
        history.unshift(`USER_IP: ${ip} :: CONNECTED`);
      }
      sessionStorage.setItem('terminal_history', JSON.stringify(history));
      renderHistory();
    } catch (e) {
      console.error('Failed to fetch IP', e);
    }
  }

  let uptimeInterval: number | null = null;

  function startUptime() {
    const startTime = new Date('2023-01-01T00:00:00').getTime();
    const counter = document.getElementById('uptime-counter');
    if (!counter) return;

    if (uptimeInterval) clearInterval(uptimeInterval);

    uptimeInterval = window.setInterval(() => {
      const now = new Date().getTime();
      const diff = now - startTime;

      const days = Math.floor(diff / (1000 * 60 * 60 * 24));
      const hours = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      counter.innerText = `${days}d ${hours.toString().padStart(2, '0')}h ${minutes.toString().padStart(2, '0')}m ${seconds.toString().padStart(2, '0')}s`;
    }, 1000);
  }

  // Track page navigation
  const currentPath = window.location.pathname;
  const pageTitle = document.title.split('|')[0].trim();
  updateSessionLog(`ACCESSING_NODE: ${currentPath} [${pageTitle}]`);

  // Listen for custom events if needed (e.g. from CLI)
  window.addEventListener('terminal-command', (e: any) => {
    updateSessionLog(`EXECUTING_CMD: ${e.detail.command}`);
  });

  document.addEventListener('DOMContentLoaded', () => {
    renderHistory();
    fetchIP();
    startUptime();
    setupPagination();
  });
  document.addEventListener('astro:page-load', () => {
    renderHistory();
    startUptime();
    setupPagination();
  });
</script>
