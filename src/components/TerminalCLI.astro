---
---
<div id="terminal-cli" class="fixed inset-0 bg-black z-[20000] translate-y-[-100%] transition-transform duration-500 font-mono p-4 md:p-12 overflow-y-auto text-[10px] md:text-xs">
  <div class="max-w-4xl mx-auto">
    <div class="text-accent-green mb-8">
      <pre class="text-[8px] md:text-xs leading-none hidden md:block">
{String.raw`
   _____                      __
  / ___/ __  __ _____ / /_ ___   ____ ___
  \__ \ / / / // ___// __// _ \ / __ \__ \
 ___/ // /_/ /(__  )/ /_ /  __// / / / / /
/____/ \__, //____/ \__/ \___//_/ /_/ /_/
      /____/
`}
      </pre>
      <pre class="text-[8px] leading-tight md:hidden">
{String.raw`
   ______ __
  / __/ // /_
 _\ \/ // __/
/___/_/ \__/ CLI
`}
      </pre>
      <p class="mt-4">[SYSTEM_V4.2]: UNAUTHORIZED ACCESS DETECTED...</p>
      <p>TYPE 'HELP' FOR COMMANDS.</p>
    </div>

    <div id="terminal-output" class="text-accent-green space-y-1 mb-4"></div>

    <div class="flex items-center text-accent-green">
      <span id="terminal-prompt" class="mr-2 whitespace-nowrap opacity-70">guest@feedback-loop:~$</span>
      <input type="text" id="terminal-input" class="bg-transparent border-none outline-none flex-grow text-accent-green" autofocus autocomplete="off" spellcheck="false" />
    </div>
  </div>
</div>

<style>
  #terminal-cli {
    scrollbar-width: thin;
    scrollbar-color: var(--accent-green) black;
  }

  .panic-animation {
    animation: screen-shake 0.1s infinite, color-invert 2s forwards;
  }

  @keyframes screen-shake {
    0% { transform: translate(0); }
    25% { transform: translate(5px, 5px); }
    50% { transform: translate(-5px, -5px); }
    75% { transform: translate(5px, -5px); }
    100% { transform: translate(-5px, 5px); }
  }

  @keyframes color-invert {
    0% { filter: invert(0); }
    50% { filter: invert(1); }
    100% { filter: invert(0); }
  }
</style>

<script>
  // Use a global variable to persist state across Astro view transitions
  if (!(window as any).terminalState) {
    (window as any).terminalState = {
      isOpen: false,
      initialized: false
    };
  }

  function toggleTerminal() {
    const state = (window as any).terminalState;
    const cli = document.getElementById('terminal-cli');
    const input = document.getElementById('terminal-input') as HTMLInputElement;
    if (!cli || !input) return;

    state.isOpen = !state.isOpen;
    if (state.isOpen) {
      cli.classList.remove('translate-y-[-100%]');
      setTimeout(() => input.focus(), 50);
    } else {
      cli.classList.add('translate-y-[-100%]');
      input.blur();
    }
  }

  function handleGlobalKeyDown(e: KeyboardEvent) {
    const state = (window as any).terminalState;
    if (e.key === '`') {
      e.preventDefault();
      toggleTerminal();
    }
    if (e.key === 'Escape' && state.isOpen) {
      toggleTerminal();
    }
  }

  function initTerminal() {
    const state = (window as any).terminalState;
    const cli = document.getElementById('terminal-cli');
    const input = document.getElementById('terminal-input') as HTMLInputElement;
    const output = document.getElementById('terminal-output');

    if (!cli || !input || !output) return;

    // Apply current state to new element (Astro replaces the DOM)
    if (state.isOpen) {
      cli.classList.remove('translate-y-[-100%]');
      setTimeout(() => input.focus(), 50);
    } else {
      cli.classList.add('translate-y-[-100%]');
    }

    // Re-add input listener
    input.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        const cmd = input.value.trim().toLowerCase();
        if (cmd) {
          handleCommand(cmd, output, cli);
        }
        input.value = '';
      }
    });

    // Ensure clicking the terminal focuses the input
    cli.addEventListener('click', () => {
      input.focus();
    });

    updatePrompt();

    if (!state.initialized) {
      window.addEventListener('keydown', handleGlobalKeyDown);
      window.addEventListener('resize', updatePrompt);
      state.initialized = true;
    }
  }

  function appendOutput(text: string, output: HTMLElement, cli: HTMLElement, type: 'cmd' | 'resp' = 'resp') {
    const line = document.createElement('div');
    const promptText = window.innerWidth < 768 ? '> ' : 'guest@feedback-loop:~$ ';
    if (type === 'cmd') {
      line.innerHTML = `<span class="opacity-50">${promptText}</span> ${text}`;
    } else {
      line.innerHTML = text;
    }
    output.appendChild(line);
    cli.scrollTop = cli.scrollHeight;
  }

  function updatePrompt() {
    const prompt = document.getElementById('terminal-prompt');
    if (prompt) {
      prompt.innerText = window.innerWidth < 768 ? '> ' : 'guest@feedback-loop:~$ ';
    }
  }

  async function handleCommand(cmd: string, output: HTMLElement, cli: HTMLElement) {
    appendOutput(cmd, output, cli, 'cmd');

    const parts = cmd.split(' ');
    const action = parts[0];
    const args = parts.slice(1);

    switch (action) {
      case 'help':
        appendOutput('COMMANDS: WHOIS [NAME], LIST_NODES, STATUS, LOGS, CLEARANCE, DATE, SUDO PANIC, EXIT, CLEAR', output, cli);
        break;
      case 'exit':
        toggleTerminal();
        break;
      case 'clear':
        output.innerHTML = '';
        break;
      case 'date':
        appendOutput(`STARDATE: ${new Date().toISOString().replace(/T/, ' ').replace(/\..+/, '')}`, output, cli);
        break;
      case 'clearance':
        appendOutput('CURRENT_ACCESS_LEVEL: [GUEST_READ_ONLY]<br/>RESTRICTION: LEVEL 04 AND ABOVE REQUIRED FOR UPLINK.', output, cli);
        break;
      case 'status':
        appendOutput('SYSTEM_STATUS: [OPERATIONAL]<br/>CPU_LOAD: 12%<br/>MEM_USAGE: 4.2GB / 16GB<br/>LATENCY: 42ms<br/>UPTIME: 142:23:05', output, cli);
        break;
      case 'logs':
        const logEntries = [
          '[OK] Algorithmic filter adjusted to 0.82',
          '[WARN] Ghost signal detected in sector 7G',
          '[OK] Scraping Deep Web node: #VOID-9',
          '[INFO] Sentinel v4.2 check complete: 0 errors',
          '[ALERT] Unauthorized attempt at /admin/backdoor blocked'
        ];
        appendOutput('RETRIEVING_SYSTEM_LOGS...', output, cli);
        setTimeout(() => {
          logEntries.forEach(log => appendOutput(log, output, cli));
        }, 200);
        break;
      case 'whois':
        if (args[0] === 'axel') {
          appendOutput('AXEL_WIRE: Street-Level Grunt. Filters raw aggression through military-grade chrome. Specialist in the pit.', output, cli);
        } else if (args[0] === 'vera') {
          appendOutput('V3RA_L1GHT: High-Altitude Signal-Jacker. Specialist in digital decay and underground frequencies.', output, cli);
        } else if (args[0] === 'patch') {
          appendOutput('PATCH: Guerilla Historian. Scavenges data from the static. Level 03 Clearance.', output, cli);
        } else if (args[0] === 'r3-cord') {
          appendOutput('R3-CORD: Historical Deep-Trace Specialist. Archivist of the old world. Level 02 Clearance.', output, cli);
        } else {
          appendOutput('ERROR: SUBJECT NOT FOUND IN DATABASE.', output, cli);
        }
        break;
      case 'list_nodes':
        appendOutput('FETCHING_LATEST_SIGNAL_NODES...', output, cli);
        setTimeout(() => {
          appendOutput('1. [NODE_NEWS] :: status:ONLINE', output, cli);
          appendOutput('2. [NODE_REVIEWS] :: status:ONLINE', output, cli);
          appendOutput('3. [NODE_VAULT] :: status:ENCRYPTED', output, cli);
          appendOutput('4. [NODE_MANIFESTO] :: status:STABLE', output, cli);
        }, 300);
        break;
      case 'sudo':
        if (args[0] === 'panic') {
          appendOutput('CRITICAL_SYSTEM_ERROR: TRIGGERING PANIC PROTOCOL...', output, cli);
          document.body.classList.add('panic-animation');
          setTimeout(() => {
            document.body.classList.remove('panic-animation');
          }, 2000);
        } else {
          appendOutput('ERROR: PERMISSION_DENIED', output, cli);
        }
        break;
      default:
        appendOutput(`ERROR: COMMAND '${action}' NOT RECOGNIZED.`, output, cli);
    }
  }

  if (typeof window !== 'undefined') {
    document.addEventListener('DOMContentLoaded', initTerminal);
    document.addEventListener('astro:page-load', initTerminal);
  }
</script>
