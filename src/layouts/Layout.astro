---
import '../styles/global.css';
import SignalProgressBar from '../components/SignalProgressBar.astro';
import TerminalCLI from '../components/TerminalCLI.astro';
import SessionLogFooter from '../components/SessionLogFooter.astro';
import SearchModule from '../components/SearchModule.astro';
import { stripMarkdown } from '../lib/utils';

interface Props {
	title: string;
	description?: string;
	keywords?: string[];
	hideNav?: boolean;
	theme?: string;
	category?: string;
	image?: string;
	articleData?: {
		author: string;
		publishedTime: string;
		modifiedTime?: string;
		section?: string;
	};
}

const { title, description, keywords, hideNav = false, theme, category, image, articleData } = Astro.props;

const defaultDescription = "THE FEEDBACK LOOP: An automated underground news experiment. Digital decay and algorithmic rebellion.";
const defaultKeywords = ["cyberpunk", "ai news", "automated journalism", "digital grunge", "subculture", "the feedback loop"];

const finalDescription = stripMarkdown(description || defaultDescription);
const finalKeywords = keywords ? [...defaultKeywords, ...keywords].join(', ') : defaultKeywords.join(', ');

const canonicalUrl = new URL(Astro.url.pathname, Astro.site);
const ogImageUrl = image
	? (image.startsWith('http') ? image : new URL(image, Astro.site).toString())
	: new URL(`${import.meta.env.BASE_URL}/favicon.png`.replace(/\/+/g, '/'), Astro.site).toString();

// JSON-LD
const baseSchema = {
	"@context": "https://schema.org",
	"@type": "WebSite",
	"name": "THE FEEDBACK LOOP",
	"url": Astro.site?.toString(),
	"description": defaultDescription
};

const articleSchema = articleData ? {
	"@context": "https://schema.org",
	"@type": "NewsArticle",
	"headline": title,
	"image": [ogImageUrl],
	"datePublished": articleData.publishedTime,
	"dateModified": articleData.modifiedTime || articleData.publishedTime,
	"author": [{
		"@type": "Person",
		"name": articleData.author,
		"url": Astro.site ? new URL(`${import.meta.env.BASE_URL}/staff/${articleData.author.toLowerCase().replace(/\s+/g, '_')}`.replace(/\/+/g, '/'), Astro.site).toString() : undefined
	}]
} : null;
---

<!doctype html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width" />
		<link rel="icon" type="image/png" href={`${import.meta.env.BASE_URL}/favicon.png`.replace(/\/+/g, '/')} />
		<meta name="generator" content={Astro.generator} />

		<!-- Google Fonts -->
		<link rel="preconnect" href="https://fonts.googleapis.com">
		<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
		<link href="https://fonts.googleapis.com/css2?family=VT323&display=swap" rel="stylesheet">

		<!-- SEO Meta Tags -->
		<meta name="description" content={finalDescription} />
		<meta name="keywords" content={finalKeywords} />
		<meta name="author" content="THE FEEDBACK LOOP" />
		<link rel="canonical" href={canonicalUrl} />

		<!-- Open Graph / Facebook -->
		<meta property="og:type" content={articleData ? "article" : "website"} />
		<meta property="og:url" content={canonicalUrl} />
		<meta property="og:site_name" content="THE FEEDBACK LOOP" />
		<meta property="og:title" content={`${title} | THE FEEDBACK LOOP`} />
		<meta property="og:description" content={finalDescription} />
		<meta property="og:image" content={ogImageUrl} />

		{articleData && (
			<>
				<meta property="article:published_time" content={articleData.publishedTime} />
				{articleData.modifiedTime && <meta property="article:modified_time" content={articleData.modifiedTime} />}
				<meta property="article:author" content={articleData.author} />
				{articleData.section && <meta property="article:section" content={articleData.section} />}
			</>
		)}

		<!-- Twitter -->
		<meta property="twitter:card" content="summary_large_image" />
		<meta property="twitter:url" content={canonicalUrl} />
		<meta property="twitter:title" content={`${title} | THE FEEDBACK LOOP`} />
		<meta property="twitter:description" content={finalDescription} />
		<meta property="twitter:image" content={ogImageUrl} />

		<!-- Structured Data -->
		<script type="application/ld+json" set:html={JSON.stringify(baseSchema)} />
		{articleSchema && <script type="application/ld+json" set:html={JSON.stringify(articleSchema)} />}

		<title>{title} | THE FEEDBACK LOOP</title>
	</head>
	<body class={`bg-background text-foreground min-h-screen flex flex-col ${category ? `category-${category}` : ''}`} data-theme={theme}>
		<div id="matrix-rain-container" class="fixed inset-0 z-[15000] pointer-events-none hidden">
			<canvas id="matrix-rain-canvas"></canvas>
		</div>

		<div id="sentinel-token-modal" class="fixed inset-0 z-[16000] flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
			<div class="terminal-box max-w-md w-full border-accent-pink shadow-[0_0_20px_rgba(255,0,255,0.5)]">
				<div class="scanline"></div>
				<div class="relative z-10 text-center">
					<h2 class="text-2xl font-bold text-accent-pink mb-4 animate-pulse">!! ACCESS GRANTED !!</h2>
					<p class="font-mono mb-4 text-xs opacity-80 uppercase tracking-widest">SENTINEL ACCESS TOKEN ACQUIRED:</p>
					<div class="bg-black border border-accent-pink p-2 font-mono text-lg tracking-widest text-white mb-6 shadow-[inset_0_0_10px_rgba(255,0,255,0.2)]">
						SNTNL-X92-K0N4M1
					</div>

					<div id="token-form-container">
						<p class="text-[10px] opacity-70 mb-4 uppercase leading-tight">Identify a subculture signal for analysis (Band, Topic, Artist):</p>
						<form id="token-form" class="space-y-4">
							<input
								type="text"
								id="token-suggestion"
								placeholder="SIGNAL_IDENTIFIER..."
								required
								class="w-full bg-black border border-accent-pink/30 p-2 font-mono text-xs focus:border-accent-pink outline-none text-accent-pink"
							/>
							<button type="submit" class="w-full py-2 bg-accent-pink text-black font-bold uppercase text-xs hover:bg-white transition-colors cursor-pointer">
								UPLOAD_TO_SENTINEL
							</button>
						</form>
					</div>
					<div id="token-success" class="hidden py-4 text-accent-green font-mono text-xs">
						> SIGNAL UPLOADED. DATA MERGED INTO SYSTEM CORE.
					</div>

					<button id="close-token-modal" class="mt-8 px-6 py-2 border border-foreground/30 text-foreground font-mono text-[10px] uppercase hover:bg-white hover:text-black transition-colors cursor-pointer">
						EXIT_PROTOCOL
					</button>
				</div>
			</div>
		</div>

		<SignalProgressBar />
		<TerminalCLI />
		<div class="crt-overlay"></div>
		{theme?.startsWith('vault') && <div class="grain-overlay"></div>}
		{!hideNav && (
			<header class="p-4 md:p-8 border-b-2 border-foreground">
				<a href={`${import.meta.env.BASE_URL}/`.replace(/\/+/g, '/')} class="block hover:opacity-80 transition-opacity">
					<pre class="font-mono text-accent-green leading-none mb-6 overflow-hidden whitespace-pre text-xs md:text-sm hidden sm:block">
{String.raw` _____ _  _ ___   ___ ___ ___ ___  ___   _   ___ _  __  _    ___   ___  ___
|_   _| || | __| | __| __| __|   \| _ ) /_\ / __| |/ / | |  / _ \ / _ \| _ \
  | | | __ | _|  | _|| _|| _|| |) | _ \/ _ \ (__| ' <  | |_| (_) | (_) |  _/
  |_| |_||_|___| |_| |___|___|___/|___/_/ \_\___|_|\_\ |____\___/ \___/|_|`}
					</pre>
					<pre class="font-mono text-accent-green leading-tight mb-6 overflow-hidden whitespace-pre text-[10px] sm:hidden">
{String.raw` _____ _  _ ___
|_   _| || | __|
  | | | __ | _|
  |_| |_||_|___|

 ___ ___ ___ ___  ___   _   ___ _  __
| __| __| __|   \| _ ) /_\ / __| |/ /
| _|| _|| _|| |) | _ \/ _ \ (__| ' <
|_| |___|___|___/|___/_/ \_\___|_|\_\

 _    ___   ___  ___
| |  / _ \ / _ \| _ \
| |_| (_) | (_) |  _/
|____\___/ \___/|_|`}
					</pre>
				</a>
				<nav class="flex flex-wrap gap-4 font-mono text-xl uppercase items-center justify-between">
					<div class="flex flex-wrap gap-4 items-center">
						<a href={`${import.meta.env.BASE_URL}/`.replace(/\/+/g, '/')} class="hover:text-accent">[HOME]</a>
						<a href={`${import.meta.env.BASE_URL}/news`.replace(/\/+/g, '/')} class="hover:text-accent">[NEWS]</a>
						<a href={`${import.meta.env.BASE_URL}/reviews`.replace(/\/+/g, '/')} class="hover:text-accent">[REVIEWS]</a>
						<a href={`${import.meta.env.BASE_URL}/vault`.replace(/\/+/g, '/')} class="hover:text-accent">[THE VAULT]</a>
						<a href={`${import.meta.env.BASE_URL}/manifesto`.replace(/\/+/g, '/')} class="hover:text-accent">[MANIFESTO]</a>
					</div>
					<div class="ml-auto">
						<SearchModule />
					</div>
				</nav>
			</header>
		)}

		<main class="flex-grow mb-6">
			<slot />
		</main>

		<SessionLogFooter />

		{!hideNav && (
			<footer class="p-8 border-t-2 border-foreground font-mono text-xs md:text-sm">
				<div class="flex flex-col md:flex-row justify-between items-center gap-4 text-center md:text-left">
					<p>GENERATED BY MACHINES. CURATED BY HUMANS. POWERED BY ASTRO & SUPABASE.</p>
					<p>HOSTED ON GITHUB. <a href="#" class="underline hover:text-accent-green">VIEW REPO</a></p>
				</div>
			</footer>
		)}

		<script>
			function scrambleText(element: HTMLElement, duration = 500) {
				const originalText = element.innerText;
				const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*()_+';
				const startTime = Date.now();

				const interval = setInterval(() => {
					const elapsedTime = Date.now() - startTime;
					if (elapsedTime >= duration) {
						element.innerText = originalText;
						clearInterval(interval);
						return;
					}

					let scrambled = '';
					for (let i = 0; i < originalText.length; i++) {
						if (originalText[i] === ' ') {
							scrambled += ' ';
						} else {
							scrambled += characters.charAt(Math.floor(Math.random() * characters.length));
						}
					}
					element.innerText = scrambled;
				}, 50);
			}

			// Run on initial load
			document.addEventListener('DOMContentLoaded', () => {
				const h1s = document.querySelectorAll('h1');
				h1s.forEach(h1 => scrambleText(h1 as HTMLElement));
			});

			// Also run on Astro page transitions if using View Transitions
			document.addEventListener('astro:page-load', () => {
				const h1s = document.querySelectorAll('h1');
				h1s.forEach(h1 => scrambleText(h1 as HTMLElement));
			});

			// Sentinel Interrupt Tooltips
			function initSentinelTooltips() {
				const interrupts = document.querySelectorAll('.sentinel-interrupt');
				let tooltip: HTMLElement | null = null;

				interrupts.forEach(interrupt => {
					interrupt.addEventListener('mouseenter', (e: any) => {
						const message = interrupt.getAttribute('data-message');
						if (!message) return;

						tooltip = document.createElement('div');
						tooltip.className = 'sentinel-tooltip';
						tooltip.innerText = message;
						document.body.appendChild(tooltip);

						const rect = interrupt.getBoundingClientRect();
						tooltip.style.left = `${rect.left + window.scrollX}px`;
						tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 10}px`;
					});

					interrupt.addEventListener('mouseleave', () => {
						if (tooltip) {
							tooltip.remove();
							tooltip = null;
						}
					});

					// For mobile
					interrupt.addEventListener('touchstart', (e: any) => {
						const message = interrupt.getAttribute('data-message');
						if (!message) return;

						if (tooltip) {
							tooltip.remove();
						}

						tooltip = document.createElement('div');
						tooltip.className = 'sentinel-tooltip';
						tooltip.innerText = message;
						document.body.appendChild(tooltip);

						const rect = interrupt.getBoundingClientRect();
						tooltip.style.left = `${rect.left + window.scrollX}px`;
						tooltip.style.top = `${rect.top + window.scrollY - tooltip.offsetHeight - 10}px`;

						e.preventDefault();
					});
				});

				document.addEventListener('touchstart', (e: any) => {
					if (tooltip && !e.target.classList.contains('sentinel-interrupt')) {
						tooltip.remove();
						tooltip = null;
					}
				});
			}

			document.addEventListener('DOMContentLoaded', initSentinelTooltips);
			document.addEventListener('astro:page-load', initSentinelTooltips);

			// Konami Code Protocol
			let konamiIndex = 0;
			const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];

			function initKonami() {
				window.addEventListener('keydown', (e) => {
					if (e.key === konamiCode[konamiIndex]) {
						konamiIndex++;
						if (konamiIndex === konamiCode.length) {
							triggerKonamiProtocol();
							konamiIndex = 0;
						}
					} else {
						konamiIndex = 0;
					}
				});
			}

			function triggerKonamiProtocol() {
				const container = document.getElementById('matrix-rain-container');
				const canvas = document.getElementById('matrix-rain-canvas') as HTMLCanvasElement;
				const modal = document.getElementById('sentinel-token-modal');
				const closeBtn = document.getElementById('close-token-modal');

				if (!container || !canvas || !modal || !closeBtn) return;

				// Start Matrix Rain
				container.classList.remove('hidden');
				startMatrixRain(canvas);

				// Show Token after a short delay
				setTimeout(() => {
					modal.classList.remove('hidden');
				}, 2000);

				// Cleanup
				setTimeout(() => {
					container.classList.add('hidden');
				}, 7000);

				const form = document.getElementById('token-form') as HTMLFormElement;
				const formContainer = document.getElementById('token-form-container');
				const successMsg = document.getElementById('token-success');

				if (form && formContainer && successMsg) {
					form.addEventListener('submit', async (e) => {
						e.preventDefault();
						const suggestion = (document.getElementById('token-suggestion') as HTMLInputElement).value;

						// Real Supabase logic would be:
						// await supabase.from('suggestions').insert([{ suggestion, date: new Date().toISOString() }])
						console.log('Sending suggestion to Supabase...', suggestion);

						formContainer.classList.add('hidden');
						successMsg.classList.remove('hidden');
					});
				}

				closeBtn.addEventListener('click', () => {
					modal.classList.add('hidden');
					// Reset form for next time
					if (formContainer) formContainer.classList.remove('hidden');
					if (successMsg) successMsg.classList.add('hidden');
					if (form) form.reset();
				});
			}

			function startMatrixRain(canvas: HTMLCanvasElement) {
				const ctx = canvas.getContext('2d');
				if (!ctx) return;

				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;

				const katakana = 'アァカサタナハマヤャラワガザダバパイィキシチニヒミリヰギジヂビピウゥクスツヌフムユュルグズヅブプエェケセテネヘメレヱゲゼデベペオォコソトノホモヨョロヲゴゾドボポヴッン';
				const latin = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ';
				const nums = '0123456789';
				const alphabet = katakana + latin + nums;

				const fontSize = 16;
				const columns = canvas.width / fontSize;

				const rainDrops: number[] = [];
				for (let x = 0; x < columns; x++) {
					rainDrops[x] = 1;
				}

				const draw = () => {
					ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
					ctx.fillRect(0, 0, canvas.width, canvas.height);

					ctx.fillStyle = '#0F0';
					ctx.font = fontSize + 'px monospace';

					for (let i = 0; i < rainDrops.length; i++) {
						const text = alphabet.charAt(Math.floor(Math.random() * alphabet.length));
						ctx.fillText(text, i * fontSize, rainDrops[i] * fontSize);

						if (rainDrops[i] * fontSize > canvas.height && Math.random() > 0.975) {
							rainDrops[i] = 0;
						}
						rainDrops[i]++;
					}
				};

				const interval = setInterval(draw, 30);
				setTimeout(() => clearInterval(interval), 7000);
			}

			document.addEventListener('DOMContentLoaded', initKonami);
			document.addEventListener('astro:page-load', initKonami);
		</script>
	</body>
</html>
