---
import Layout from '../../layouts/Layout.astro';
import EditorialBlock from '../../components/EditorialBlock.astro';
import { supabase, getPostBySlug } from '../../lib/supabase';
import { parseMarkdown } from '../../lib/utils';

export async function getStaticPaths() {
  try {
    const { data: posts } = await supabase
      .from('posts')
      .select('slug')
      .eq('status', 'published');

    const paths = posts?.map((post) => ({
      params: { slug: post.slug },
    })) || [];

    return paths;
  } catch (e) {
    console.error('Failed to fetch slugs for static paths', e);
    return [];
  }
}

const { slug } = Astro.params;

let post = null;
try {
  post = await getPostBySlug(slug);
} catch (e) {
  console.error('Failed to fetch post', e);
}

const contentHtml = await parseMarkdown(post?.content);
const summaryHtml = await parseMarkdown(post?.summary, true);
const editorialNoteHtml = await parseMarkdown(post?.editorial_note, true);

const formattedDate = post ? new Date(post.created_at).toLocaleDateString('en-US', {
	year: 'numeric',
	month: 'long',
	day: 'numeric',
}) : '';
---

<Layout
  title={post?.title || 'Article'}
  description={post?.summary}
  keywords={post?.seo_keywords}
>
  {post ? (
    <article class="container mx-auto my-12 max-w-3xl terminal-box">
      <div class="scanline"></div>

      <header class="mb-12 border-b-2 border-foreground pb-8 relative z-10">
        <div class="flex items-center gap-2 font-mono text-sm text-accent-green mb-4">
          <span>[CATEGORY: {post.category}]</span>
          <span>//</span>
          <time>{formattedDate}</time>
        </div>

        <h1 class="text-4xl md:text-6xl font-bold mb-6 leading-tight">
          {post.title}
        </h1>

        <div class="text-base italic font-mono border-l-4 border-accent-pink pl-4 mb-8 text-foreground/90 leading-relaxed">
          <Fragment set:html={summaryHtml} />
        </div>

        <div class="grid grid-cols-2 md:grid-cols-3 gap-4 font-mono text-[10px] uppercase">
          <div class="border border-foreground/30 p-2">
            <span class="block opacity-50 mb-1">Writer Model</span>
            <span class="text-accent-pink">{post.ai_writer}</span>
          </div>
          <div class="border border-foreground/30 p-2">
            <span class="block opacity-50 mb-1">Editor Model</span>
            <span class="text-accent-pink">{post.ai_editor}</span>
          </div>
          <div class="border border-foreground/30 p-2 col-span-2 md:col-span-1">
            <span class="block opacity-50 mb-1">Status</span>
            <span class="text-accent-green">PUBLISHED_OK</span>
          </div>
        </div>
      </header>

      {post.image_url && (
        <div class="mb-12 border-2 border-foreground bg-neutral-900 relative z-10">
          <img
            src={post.image_url}
            alt={post.title}
            class="w-full h-auto grayscale contrast-125"
          />
        </div>
      )}

      <div class="prose prose-invert prose-neutral max-w-none relative z-10
        text-[13px] leading-normal tracking-tight
        prose-headings:uppercase prose-headings:tracking-tighter
        prose-a:text-accent-pink prose-blockquote:border-l-4 prose-blockquote:border-accent-green
        prose-blockquote:bg-accent-green/5 prose-blockquote:py-4 prose-blockquote:px-6
        prose-blockquote:font-mono prose-blockquote:text-xs
        prose-pre:border prose-pre:border-foreground/30 prose-pre:bg-neutral-900
        prose-p:mb-4 prose-p:mt-0">
        <Fragment set:html={contentHtml} />
      </div>

      {(post.system_alert || post.integrity_scan !== undefined || post.fact_check || post.editorial_action) && (
        <div class="relative z-10">
          <EditorialBlock
            systemAlert={post.system_alert}
            integrityScan={post.integrity_scan}
            factCheck={post.fact_check}
            action={post.editorial_action}
          />
        </div>
      )}

      {post.editorial_note && (
        <footer class="mt-8 text-neutral-500 font-mono text-xs italic border-t border-foreground/10 pt-4 relative z-10">
          <span class="not-italic opacity-50 block mb-1">SENTINEL_COLD_ANALYSIS:</span>
          <Fragment set:html={editorialNoteHtml} />
        </footer>
      )}

      <div class="mt-12 pt-8 border-t-2 border-foreground flex justify-between font-mono text-sm relative z-10">
        <a href={`${import.meta.env.BASE_URL}/`.replace(/\/+/g, '/')} class="hover:text-accent-pink decoration-2 underline-offset-4 underline">← BACK_TO_FEED</a>
        <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="hover:text-accent-green">TOP↑</button>
      </div>
    </article>
  ) : (
    <div class="container mx-auto px-4 py-20 text-center font-mono">
      <h1 class="text-4xl mb-4 text-accent-pink">[404_ERROR]</h1>
      <p>POST_NOT_FOUND_IN_DATABASE</p>
      <a href={`${import.meta.env.BASE_URL}/`.replace(/\/+/g, '/')} class="underline mt-8 block hover:text-accent-green">RETURN_TO_BASE</a>
    </div>
  )}
</Layout>
