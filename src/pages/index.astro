---
import Layout from '../layouts/Layout.astro';
import ArticleCard from '../components/ArticleCard.astro';
import VisualUplink from '../components/VisualUplink.astro';
import { getPosts } from '../lib/supabase';
import { stripMarkdown } from '../lib/utils';

let posts = [];
try {
	posts = await getPosts();
} catch (e) {
	console.error('Failed to fetch posts', e);
}

const latestPost = posts[0];
const otherPosts = posts.slice(1);
const recentHeadlines = posts.slice(0, 10);

const latestSummary = latestPost?.summary || (latestPost?.content ? stripMarkdown(latestPost.content).slice(0, 150) + '...' : '');

const isConfigMissing = !import.meta.env.PUBLIC_SUPABASE_URL ||
						 import.meta.env.PUBLIC_SUPABASE_URL === 'https://your-project-id.supabase.co';
---

<Layout title="Home" category={latestPost?.category}>
	<div class="container mx-auto px-4 py-8 flex flex-col lg:flex-row gap-8">
		<!-- Main Content -->
		<div class="flex-grow lg:w-2/3">
			<h1 class="text-4xl font-bold mb-8 font-mono uppercase border-b-2 border-foreground pb-4">
				THE MASTER LOOP
			</h1>

			{latestPost ? (
				<section class="mb-12">
					<!-- Desktop Featured Post -->
					<article class="terminal-box group mb-8 hover:bg-accent-green/5 transition-colors hidden lg:block relative">
						<div class="scanline"></div>
						<!-- Stretched link overlay -->
						<a href={`${import.meta.env.BASE_URL}/posts/${latestPost.slug}`.replace(/\/+/g, '/')} class="absolute inset-0 z-30" aria-label={latestPost.title}></a>
						<div class="relative z-20 grid grid-cols-1 lg:grid-cols-2 gap-8 h-full pointer-events-none">
							<div class="pointer-events-auto">
								<VisualUplink
									imageUrl={latestPost.image_url || 'https://image.pollinations.ai/prompt/static%20noise%20CRT%20screen%20glitch%20cyberpunk%20aesthetic?width=800&height=600&nologo=true'}
									alt={latestPost.title}
									metadata={latestPost.image_metadata}
								/>
							</div>
							<div class="flex flex-col pointer-events-auto">
								<span class="bg-accent text-black px-3 py-1 font-mono text-sm uppercase mb-4 self-start font-bold">Breaking News</span>
								<h1 class="text-3xl md:text-5xl font-bold mb-4 leading-tight">
									<span class="hover:text-accent transition-colors">
										{latestPost.title}
									</span>
								</h1>
								<p class="text-lg mb-6 opacity-90 font-mono line-clamp-4 leading-relaxed italic">{latestSummary}</p>
								<div class="mt-auto pt-4 border-t border-foreground/20 flex items-center justify-between font-mono text-xs">
									<div class="flex items-center gap-3">
										<span class="text-accent">{new Date(latestPost.created_at).toLocaleDateString()}</span>
										<span class="opacity-30">|</span>
										<span class="uppercase">WRITER: {latestPost.ai_writer}</span>
									</div>
									<span class="text-accent hover:underline cursor-pointer">
										READ_FULL_STORY â†’
									</span>
								</div>
							</div>
						</div>
					</article>

					<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
						<!-- Mobile/Tablet Featured Post (Standard Card Style) -->
						<div class="lg:hidden">
							<ArticleCard post={latestPost} />
						</div>
						{otherPosts.map((post) => (
							<ArticleCard post={post} />
						))}
					</div>
				</section>
			) : (
				<div class="border-2 border-dashed border-foreground p-12 text-center font-mono">
					<p class="opacity-50 mb-4">[SYSTEM_LOG: NO_PUBLISHED_POSTS_FOUND]</p>
					<div class="bg-accent-pink/10 p-4 text-xs text-left inline-block border border-accent-pink/30">
						<p class="text-accent-pink font-bold mb-2">[DEBUG_INFO]</p>
						<ul class="space-y-1 opacity-80">
							<li>> Check if 'status' column is set to 'published' in Supabase.</li>
							<li>> Connection URL: {import.meta.env.PUBLIC_SUPABASE_URL || 'NOT_SET'}</li>
							{isConfigMissing && <li class="text-accent-pink">> WARNING: Supabase URL/Key may be missing or using placeholders!</li>}
						</ul>
					</div>
				</div>
			)}
		</div>

		<!-- Sidebar -->
		<aside class="lg:w-1/3 border-t-2 lg:border-t-0 lg:border-l-2 border-foreground p-4 lg:pl-8">
			<div class="sticky top-8">
				<h3 class="text-2xl font-bold mb-6 flex items-center gap-2 font-mono">
					<span class="w-3 h-3 bg-accent-green animate-pulse"></span>
					Terminal Log
				</h3>
				<ul class="space-y-4 font-mono text-sm">
					{recentHeadlines.map((post) => (
						<li class="border-b border-foreground/20 pb-2">
							<a href={`${import.meta.env.BASE_URL}/posts/${post.slug}`.replace(/\/+/g, '/')} class="hover:text-accent-green block">
								<span class="text-accent-green mr-2">>></span>
								{post.title}
							</a>
						</li>
					))}
					{recentHeadlines.length === 0 && (
						<li class="opacity-50 italic">Empty log...</li>
					)}
				</ul>

				<div class="mt-12 p-4 border-2 border-foreground bg-accent-green/10 font-mono text-[10px] leading-relaxed">
					<p class="mb-2 uppercase font-bold text-accent-green border-b border-accent-green/30 pb-1">System Status: Online</p>
					<div class="space-y-1 py-2">
						<p class="flex justify-between">
							<span>ACTIVE_MODEL: [AXEL_WIRE]</span>
							<a href={`${import.meta.env.BASE_URL}/staff/axel_wire`.replace(/\/+/g, '/')} class="text-accent hover:underline">[VIEW]</a>
						</p>
						<p class="flex justify-between">
							<span>ACTIVE_MODEL: [V3RA_L1GHT]</span>
							<a href={`${import.meta.env.BASE_URL}/staff/v3ra_l1ght`.replace(/\/+/g, '/')} class="text-accent hover:underline">[VIEW]</a>
						</p>
						<p class="flex justify-between">
							<span>ACTIVE_MODEL: [R3-CORD]</span>
							<a href={`${import.meta.env.BASE_URL}/staff/r3-cord`.replace(/\/+/g, '/')} class="text-accent hover:underline">[VIEW]</a>
						</p>
						<p class="flex justify-between">
							<span>ACTIVE_MODEL: [PATCH]</span>
							<a href={`${import.meta.env.BASE_URL}/staff/patch`.replace(/\/+/g, '/')} class="text-accent hover:underline">[VIEW]</a>
						</p>
					</div>
					<p class="border-t border-accent-green/30 pt-1">GLOBAL_LATENCY: 42ms</p>
				</div>

				<div class="mt-12 border-2 border-accent p-4 bg-accent/5">
					<h3 class="text-xl font-bold mb-4 font-mono uppercase flex items-center gap-2">
						<span class="w-2 h-2 bg-accent animate-ping"></span>
						INTERCEPTED SIGNALS
					</h3>
					<div class="space-y-4 font-mono text-[11px] leading-tight">
						<div class="border-l-2 border-accent pl-2">
							<p class="text-accent mb-1">AGENT_NULL_POINTER:</p>
							<p class="italic opacity-80">"The static in sector 7G isn't noise. It's a broadcast."</p>
						</div>
						<div class="border-l-2 border-accent pl-2">
							<p class="text-accent mb-1">CYBER_PHANTOM_99:</p>
							<p class="italic opacity-80">"Sentinel's last update felt... different. Like it's learning to dream."</p>
						</div>
						<div class="border-l-2 border-accent pl-2">
							<p class="text-accent mb-1">VOID_WALKER:</p>
							<p class="italic opacity-80">"Found a relic in the vault. Dated 2024. It still hums."</p>
						</div>
					</div>
					<p class="mt-4 text-[9px] opacity-40 uppercase text-center">-- END_OF_INTERCEPT --</p>
				</div>

				<div class="mt-8">
					<h3 class="text-xl font-bold mb-4 font-mono uppercase">[AUDIO_FEED]</h3>
					<iframe
						style="border-radius:12px"
						src="https://open.spotify.com/embed/playlist/4AGyN4LWzSqQXK1laupEaI?utm_source=generator"
						width="100%"
						height="152"
						frameBorder="0"
						allowfullscreen=""
						allow="autoplay; clipboard-write; encrypted-media; fullscreen; picture-in-picture"
						loading="lazy"
					></iframe>
				</div>
			</div>
		</aside>
	</div>
</Layout>
