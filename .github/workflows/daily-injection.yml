name: Daily Content Injection

on:
  schedule:
    # Runs at 09:00 UTC every day
    - cron: '0 9 * * *'
  # Allows you to run this manually from the Actions tab for testing
  workflow_dispatch:

jobs:
  inject-content:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '20'

      - name: Install Dependencies
        run: npm ci

      - name: Run Newsroom Script
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          PUBLIC_SUPABASE_URL: ${{ secrets.PUBLIC_SUPABASE_URL }}
          PUBLIC_SUPABASE_ANON_KEY: ${{ secrets.PUBLIC_SUPABASE_ANON_KEY }}
        run: |
          # 1. Define the list of personas
          personas=("AXEL" "V3RA" "R3-CORD" "PATCH")

          # 2. Pick a random index
          size=${#personas[@]}
          index=$(($RANDOM % $size))
          selected_writer=${personas[$index]}

          echo "Selected Persona for Today: $selected_writer"

          # 3. Run the script with the selected writer
          node newsroom.js --writer=$selected_writer

      - name: Run ISO_GHO5T Visualizer
        env:
          # We need both Supabase and Google keys for the Director protocol
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          # Note: If you have a separate SUPABASE_SERVICE_ROLE_KEY secret, use that here instead of SUPABASE_KEY for better permission handling.
        run: |
          echo "Starting visual artifact generation..."
          node visualizer.js
